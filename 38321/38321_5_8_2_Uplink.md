### 5.8.2 Uplink

There are two types of transmission without dynamic grant:

\- configured grant Type 1 where an uplink grant is provided by RRC, and
stored as configured uplink grant;

\- configured grant Type 2 where an uplink grant is provided by PDCCH,
and stored or cleared as configured uplink grant based on L1 signalling
indicating configured uplink grant activation or deactivation.

Type 1 and Type 2 are configured by RRC for a Serving Cell per BWP.
Multiple configurations can be active simultaneously in the same BWP.
For Type 2, activation and deactivation are independent among the
Serving Cells. For the same BWP, the MAC entity can be configured with
both Type 1 and Type 2.

A multi-PUSCH configured grant has multiple consecutive configured
uplink grants within a *periodicity*. Both Type 1 and Type 2 can be
configured for a multi-PUSCH configured grant by RRC.

Only configured grant Type 1 can be configured for CG-SDT or for
RACH-less LTM cell switch or for RACH-less handover. CG-SDT can only be
configured on initial BWP.

RRC configures the following parameters when the configured grant Type 1
is configured:

\- *cs-RNTI*: CS-RNTI for retransmission;

\- *cg-SDT-CS-RNTI*: CS-RNTI for CG-SDT retransmission;

\- *cg-SDT-RSRP-ThresholdSSB*: an RSRP threshold configured for SSB
selection for CG-SDT;

\- *cg-RRC-RSRP-ThresholdSSB*: an RSRP threshold configured for SSB
selection for RACH-less handover;

\- *periodicity*: periodicity of the configured grant Type 1;

\- *timeDomainOffset*: Offset of a resource with respect to SFN =
*timeReferenceSFN* in time domain;

\- *timeDomainAllocation*: Allocation of configured uplink grant in time
domain which contains *startSymbolAndLength* (i.e. *SLIV* in TS 38.214
\[7\]) or *startSymbol* (i.e. *S* in TS 38.214 \[7\]);

\- *nrofHARQ-Processes*: the number of HARQ processes for configured
grant;

\- *harq-ProcID-Offset*: offset of HARQ process for configured grant
configured with *cg-RetransmissionTimer* for operation with shared
spectrum channel access;

\- *harq-ProcID-Offset2*: offset of HARQ process for configured grant
not configured with *cg-RetransmissionTimer*;

\- *timeReferenceSFN*: SFN used for determination of the offset of a
resource in time domain. The UE uses the closest SFN with the indicated
number preceding the reception of the configured grant configuration;

\- *timeReferenceHyperSFN*: H-SFN used for determination of the offset
of a resource in time domain. The UE uses the closest H-SFN with the
indicated number preceding the reception of the configured grant
configuration.

RRC configures the following parameters when the configured grant Type 2
is configured:

\- *cs-RNTI*: CS-RNTI for activation, deactivation, and retransmission;

\- *periodicity*: periodicity of the configured grant Type 2;

\- *nrofHARQ-Processes*: the number of HARQ processes for configured
grant;

\- *harq-ProcID-Offset*: offset of HARQ process for configured grant
configured with *cg-RetransmissionTimer* for operation with shared
spectrum channel access;

\- *harq-ProcID-Offset2*: offset of HARQ process for configured grant
not configured with *cg-RetransmissionTimer*.

RRC configures the following parameter when retransmissions on
configured uplink grant is configured:

\- *cg-RetransmissionTimer*: the duration after a configured grant
(re)transmission of a HARQ process when the UE shall not autonomously
retransmit that HARQ process;

\- *cg-SDT-RetransmissionTimer*: the duration after a configured grant
(re)transmission of a HARQ process of the initial CG-SDT transmission
with CCCH message when the UE shall not autonomously retransmit the HARQ
process;

\- *cg-RRC-RetransmissionTimer*: the duration after a configured grant
(re)transmission of a HARQ process of the first PUSCH transmission of
RACH-less handover and RACH-less LTM cell switch when the UE shall not
autonomously retransmit the HARQ process.

RRC configures the following parameter when a multi-PUSCH configured
grant is configured:

*- nrofSlotsInCG-Period*: the number of configured uplink grants in a
*periodicity* of a multi-PUSCH configured grant.

RRC configures the following parameter when UTO-UCI (as specified in
clause 9.3 in TS 38.213 \[6\]) is configured for a configured grant:

*- nrofBitsInUTO-UCI*: number of bits in a UTO-UCI bitmap.

For a configured uplink grant, the MAC entity shall:

1\> if its associated configured grant is configured with UTO-UCI and it
has not been indicated to the lower layers as unused for PUSCH
transmission; or

1\> if its associated configured grant is not configured with UTO-UCI:

2\> if it is associated with a multi-PUSCH configured grant and meets
the validity conditions specified in the clause 6.1 in TS 38.214 \[7\];
or

2\> if it is not associated with a multi-PUSCH configured grant:

3\> consider it available for use.

The MAC entity shall not include the UL-SCH resource of a configured
uplink grant not available for use in its procedures (e.g. in clauses
5.4.1 and 5.4.4).

For a configured grant configured with UTO-UCI, the MAC entity
determines if a configured uplink grant which is within the subsequent
*nrofBitsInUTO-UCI* valid occasions of its associated configured grant
configuration is going to be used for PUSCH transmission by considering
at least the amount of buffered data that can be transmitted on the
available occasions of the associated configured grant and other
available UL-SCH resources. Upon this determination, the MAC entity
sends an indication to lower layers, for use in the procedure for
reporting UTO-UCI.

Upon configuration of a configured grant Type 1 for a BWP of a Serving
Cell by upper layers, the MAC entity shall:

1\> store the uplink grant provided by upper layers as a configured
uplink grant for the indicated BWP of the Serving Cell;

1\> if *cg-SDT-PeriodicityExt* is configured:

2\> initialise or re-initialise the configured uplink grant to start in
the symbol according to *timeDomainOffset*, *timeReferenceHyperSFN,
timeReferenceSFN*, and *S* (derived from *SLIV* or provided by
*startSymbol* as specified in TS 38.214 \[7\]), and to reoccur with
*cg-SDT-PeriodicityExt*.

1\> else:

2\> initialise or re-initialise the configured uplink grant to start in
the symbol according to *timeDomainOffset*, *timeReferenceSFN*, and *S*
(derived from *SLIV* or provided by *startSymbol* as specified in TS
38.214 \[7\]), and to reoccur with *periodicity*.

If *cg-SDT-PeriodicityExt* (as defined in TS 38.331 \[5\]) is not
configured, after an uplink grant is configured for a configured grant
Type 1, the MAC entity shall consider sequentially that the configured
uplink grant, or the first configured uplink grant in a multi-PUSCH
configured grant, in the N^th^ (N ≥ 0) *periodicity* occurs in the
symbol for which:

\[(SFN × *numberOfSlotsPerFrame* × *numberOfSymbolsPerSlot*)\
+ (slot number in the frame × *numberOfSymbolsPerSlot*) + symbol number
in the slot\] =\
(*timeReferenceSFN* × *numberOfSlotsPerFrame* ×
*numberOfSymbolsPerSlot*\
+ *timeDomainOffset* × *numberOfSymbolsPerSlot* + S + N ×
*periodicity*)\
modulo (1024 × *numberOfSlotsPerFrame* × *numberOfSymbolsPerSlot*)

If *cg-SDT-PeriodicityExt* (as defined in TS 38.331 \[5\]) is
configured, after an uplink grant is configured for a configured grant
Type 1, the MAC entity shall consider sequentially that the configured
uplink grant in the N^th^ (N ≥ 0) *periodicity* occurs in the symbol for
which:

\[(H-SFN × *numberOfSFNperH-SFN* + SFN) × *numberOfSlotsPerFrame* ×
*numberOfSymbolsPerSlot*\
+ (slot number in the frame × *numberOfSymbolsPerSlot*) + symbol number
in the slot\] =\
((*timeReferenceHyperSFN* × *numberOfSFNperH-SFN + timeReferenceSFN*)\
× *numberOfSlotsPerFrame* × *numberOfSymbolsPerSlot*\
+ *timeDomainOffset* × *numberOfSymbolsPerSlot* + S + N ×
*cg-SDT-PeriodicityExt*)\
modulo (1024 × 1024 × *numberOfSlotsPerFrame* ×
*numberOfSymbolsPerSlot*)

For a multi-PUSCH configured grant Type 1, the M^th^ (1 \< M ≤
*nrofSlotsInCG-Period*) configured uplink grant within a *periodicity*
occurs (M-1) × *numberOfSymbolsPerSlot* symbols after the symbol in
which the first configured uplink grant in that *periodicity* occurs.

For an uplink grant configured for configured grant Type 1 for CG-SDT on
the selected uplink carrier as in clause 5.27, when CG-SDT is triggered
and not terminated, for each configured uplink grant valid according to
TS 38.214 \[7\] for which the above formula is satisfied, the MAC entity
shall:

1\> if, after initial transmission for CG-SDT with CCCH message has been
performed according to clause 5.4.1, PDCCH addressed to the MAC
entity\'s C-RNTI has not been received:

2\> if the SSB corresponding to the configured UL grant has the same SSB
index as the SSB selected for initial transmission for CG-SDT with CCCH
message (i.e., retransmission of initial transmission of CG-SDT):

3\> select this SSB;

3\> indicate the SSB index corresponding to the configured uplink grant
to the lower layer;

3\> consider this configured uplink grant as valid.

1\> else if at least one SSB corresponding to the configured uplink
grant with SS-RSRP above the *cg-SDT-RSRP-ThresholdSSB* is available:

2\> if this is the initial transmission of CG-SDT with CCCH message
after the CG-SDT procedure is initiated as in clause 5.27 (i.e., initial
transmission for CG-SDT):

3\> select an SSB with SS-RSRP above *cg-SDT-RSRP-ThresholdSSB* amongst
the SSB(s) associated with the configured uplink grant.

2\> else if PDCCH addressed to C-RNTI has been received after the
initial transmission of CG-SDT with CCCH message (i.e., subsequent new
transmission for CG-SDT):

3\> if SS-RSRP of the SSB selected for the previous transmission for
CG-SDT is above *cg-SDT-RSRP-ThresholdSSB* and this SSB is associated
with this configured uplink grant:

4\> select this SSB.

3\> else if SS-RSRP of the SSB selected for the previous transmission
for CG-SDT is not above *cg-SDT-RSRP-ThresholdSSB*:

4\> select an SSB with SS-RSRP above *cg-SDT-RSRP-ThresholdSSB* amongst
the SSB(s) associated with the configured uplink grant.

2\> if SSB is selected above:

3\> indicate the SSB index to the lower layer;

3\> consider this configured uplink grant as valid.

The MAC entity shall:

1\> if no SSB configured for CG-SDT with SS-RSRP above
*cg-SDT-RSRP-ThresholdSSB* is available:

2\> if PDCCH addressed to C-RNTI after the initial transmission of the
CG-SDT with CCCH message has been received:

3\> if there is data available for transmission for at least one RB
configured for SDT:

4\> initiate Random Access procedure in clause 5.1.

NOTE 1: Void.

For an uplink grant configured for configured grant Type 1 for RACH-less
LTM cell switch, when there is an ongoing RACH-less LTM cell switch
procedure, for each configured uplink grant valid according to TS 38.214
\[7\] for which the above formula is satisfied, the MAC entity shall:

1\> if an SSB corresponding to the configured UL grant has the same SSB
index as the SSB associated with the TCI state indicated by the UL TCI
state ID field, if present, or by the TCI state ID field otherwise, in
the LTM Cell Switch Command MAC CE, as specified in clause 21.1 in TS
38.213 \[6\]:

2\> select the SSB associated with the TCI state indicated by LTM Cell
Switch Command MAC CE.

2\> indicate the SSB index to the lower layer;

2\> consider this configured uplink grant as valid.

1\> else:

2\> consider this configured uplink grant as not valid.

NOTE 1a: When there is an ongoing RACH-less LTM cell switch, the
configured grant Type 1 which is not specifically configured for LTM
(see *cg-LTM-Configuration* in TS 38.331 \[5\]) is not used.

NOTE 1b: After completion of LTM cell switch, the UE stops using the
grant configured for RACH-less LTM cell switch (see
*cg-LTM-Configuration* in TS 38.331 \[5\]).

For the uplink grant configured for configured grant Type 1 for
RACH-less handover, if the configured uplink grant is valid according to
TS 38.214 \[7\] for which the above formula is satisfied and RACH-less
handover is not successfully completed, the MAC entity shall:

1\> if the first PUSCH transmission of RACH-less handover has been
performed according to clause 5.4.1 and 5.33:

2\> if the SSB corresponding to the configured UL grant has the same SSB
index as the SSB selected for the first PUSCH transmission of RACH-less
handover (i.e., retransmission of the first PUSCH transmission of
RACH-less handover):

3\> select this SSB;

3\> indicate the SSB index corresponding to the configured uplink grant
to the lower layer;

3\> consider this configured uplink grant as valid.

1\> else if at least one SSB corresponding to the configured uplink
grant with SS-RSRP above *cg-RRC-RSRP-ThresholdSSB* is available:

2\> select an SSB with SS-RSRP above *cg-RRC-RSRP-ThresholdSSB* amongst
the SSB(s) associated with the configured uplink grant;

2\> indicate the selected SSB index to the lower layer;

2\> consider this configured uplink grant as valid.

The MAC entity shall:

1\> if no SSB configured for RACH-less handover with SS-RSRP above
*cg-RRC-RSRP-ThresholdSSB* is available:

2\> initiate Random Access procedure in clause 5.1.

NOTE 1A: When the UE determines if there is an SSB with SS-RSRP above
*cg-RRC-RSRP-ThresholdSSB* or *cg-SDT-RSRP-ThresholdSSB*, the UE uses
the latest unfiltered L1-RSRP measurement.

After an uplink grant is configured for a configured grant Type 2, the
MAC entity shall consider sequentially that the configured uplink grant,
or the first configured uplink grant in a multi-PUSCH configured grant,
in the N^th^ (N ≥ 0) *periodicity* occurs in the symbol for which:

\[(SFN × *numberOfSlotsPerFrame* × *numberOfSymbolsPerSlot*)\
+ (slot number in the frame × *numberOfSymbolsPerSlot*) + symbol number
in the slot\] =\
\[(SFN~start\ time~ × *numberOfSlotsPerFrame* ×
*numberOfSymbolsPerSlot*\
+ slot~start\ time~ × *numberOfSymbolsPerSlot* + symbol~start\ time~) +
N × *periodicity*\]\
modulo (1024 × *numberOfSlotsPerFrame* × *numberOfSymbolsPerSlot*)

where SFN~start\ time~, slot~start\ time~, and symbol~start\ time~ are
the SFN, slot, and symbol, respectively, of the first transmission
opportunity of PUSCH where the configured uplink grant was
(re-)initialised.

For a multi-PUSCH configured grant Type 2, the M^th^ (1 \< M ≤
*nrofSlotsInCG-Period*) configured uplink grant within the same
*periodicity* occurs (M-1) × *numberOfSymbolsPerSlot* symbols after the
symbol in which the first configured uplink grant in that *periodicity*
occurs.

If *cg-nrofPUSCH-InSlot* or *cg-nrofSlots* is configured for a
configured grant Type 1 or Type 2, the MAC entity shall consider the
uplink grants occur in those additional PUSCH allocations as specified
in clause 6.1.2.3 of TS 38.214 \[7\].

NOTE 2: In case of unaligned SFN across carriers in a cell group, the
SFN of the concerned Serving Cell is used to calculate the occurrences
of configured uplink grants.

When the configured uplink grant is released by upper layers, all the
corresponding configurations shall be released and all corresponding
uplink grants shall be cleared.

The MAC entity shall:

1\> if at least one configured uplink grant confirmation has been
triggered and not cancelled; and

1\> if the MAC entity has UL resources allocated for new transmission:

2\> if, in this MAC entity, at least one configured uplink grant is
configured by *configuredGrantConfigToAddModList*:

3\> instruct the Multiplexing and Assembly procedure to generate a
Multiple Entry Configured Grant Confirmation MAC CE as defined in clause
6.1.3.31.

2\> else:

3\> instruct the Multiplexing and Assembly procedure to generate a
Configured Grant Confirmation MAC CE as defined in clause 6.1.3.7.

2\> cancel all triggered configured uplink grant confirmation(s).

For a configured grant Type 2, the MAC entity shall clear the configured
uplink grant(s) immediately after first transmission of Configured Grant
Confirmation MAC CE or Multiple Entry Configured Grant Confirmation MAC
CE which confirms the configured uplink grant deactivation.

Retransmissions use:

\- repetition of configured uplink grants; or

\- received uplink grants addressed to CS-RNTI; or

\- configured uplink grants with *cg-RetransmissionTimer*,
*cg-RRC-RetransmissionTimer* or *cg-SDT-RetransmissionTimer* configured.